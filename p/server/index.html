<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>

<body>
  <h5>Nodejs服务搭建流水账</h5>
  <ul>
    <li><span>pm2</span></li>
    <ul>
      <li><a href="../node/pm2.html">安装pm2</a></li>
    </ul>
    <li><span>Express</span>
      <ul>
        <li><a href="../node/express.html">安装Express</a></li>
      </ul>
    </li>
    <li><span>Nginx配置</span>
      <ul>
        <li><a href="../nginx/simple.html">反向代理的配置</a> </li>
      </ul>
    </li>
    <li><span>app.js</span>
      <ul>
        <li>新建app.js,内容如下</li>
        <li>
          <pre>
            <code>            
              var express = require('express');
              var app = express();

              app.get('/', function (req, res) {
                res.send('Hello World!');
              });

              app.listen(3000, function () {
                console.log('Example app listening on port 3000!');
              });
              process.on('SIGINT', function() {
                 db.stop(function(err) {
                   process.exit(err ? 1 : 0);
                 });
              });
          </code>
          </pre>
        </li>
      </ul>
    </li>
    <li><span>pm2 启动</span>
      <ul>
        <li>
          <pre>
          <code>
            pm2 start app.js
          </code>
        </pre>
        </li>
        <li><span><a href="http://pm2.keymetrics.io/docs/usage/startup/">pm2 开机启动</a></span>
          <p>之所以选择这种方式是由于配置文件未来可以自动生成,可以配置更多多个app,以及可以部署配置</p>
          <pre>
          <code>
            $ pm2 ecosystem
          </code>
          会在当前目录生成ecosystem.config.js,我的内容如下
          <code>
            module.exports = {
              /**
               * Application configuration section
               * http://pm2.keymetrics.io/docs/usage/application-declaration/
               */
              apps: [{
                "name": "dream_be",
                "script": "/home/xxx/webroot/app.js",
                "instances": 0,
                "watch": true,
                "exec_mode": "cluster",
                "cwd": "/home/xxx",
                "env": {
                  "NODE_ENV": "development",
                },
                "env_production": {
                  "NODE_ENV": "production"
                }
              }]
            };            
          </code>
          启动,保存进程信息.
          <code>
            pm2 start /home/xxx/ecosystem.config.js
            pm2 save
            pm2 startup systemd -u xxx
            # 会输出一条命令,复制执行即可 例如: sudo env PATH=$PATH:/opt/node-v6.10.3-linux-x64/bin pm2 startup systemd -u xxx --hp /home/xxx
          </code>
        </pre>
        </li>
      </ul>
    </li>
    <li><span>Nginx 重启</span>
      <ul>
        <li>
          <pre>
          <code>
            sudo systemctl restart nginx
          </code>
        </pre>
        </li>
      </ul>
    </li>
    <li><span>测试</span>
      <ul>
        <li>
          <pre>
          <code>
            curl 192.168.2.82 # 这是我自己的虚拟机地址也可以浏览器访问

            < Hello World!
          </code>
        </pre>
        </li>
      </ul>
    </li>
  </ul>
  <p>现在考虑的是Express路由文件如何管理.期望达到的效果有.
    <ul>
      <li><span>1. url直接映射为文件,方便管理</span></li>
      <li><span>2. 最好能够提供热重载,无需重启整个服务器,既能针对单个handle更新</span></li>
    </ul>
  </p>
  <p>
    参考了<a href="http://fex.baidu.com/blog/2015/05/nodejs-hot-swapping/">热更</a>的思路和<a href="http://blog.fantasy.codes/node.js/2016/10/08/express-route-loader/">自动路由加载</a>可以结合一下,完成一个路由文件加载机制,暴露get,reload,update函数.app运行时通过get来获取对应的路由处理handle,路由文件的更新不是通过文件的覆盖,而是通过update函数更新路由文件.更新完之后通过reload来重新加载最新的路由文件,同时对处理中的请求继续处理.同时在服务启动的时候一次性加载所有handle
  </p>
  <p>实际运行的时候服务器端代码是否需要编译?如果需要选择什么编译框架比较好?</p>
  <p>现在思路有点乱了.....</p>
  <p>回到正轨,首先需要把程序跑起来,然后再做各个目录的规划</p>
  <p>
    <ul>
      <li>首先分离客户端代码和服务器端代码</li>
      <li>Ningx能够动静分离配置</li>
    </ul>
  </p>
  <p>重新规划服务器上目录结构</p>
  <p>
    <pre>
    <code>
    /home/xx/webroot/
      server/ 服务端目录
        handle/ 提供rest接口
        libs/ 库文件
        middle/ connect中的middleware
        utils/ 工具文件
      client/ 客户端目录
        static/ 纯静态文件
          img/
          js/
          css/
        tpl/ 预计是页面的template文件 这个文件暂时没有考虑好,主要是暂时不清楚如何组装页面
    </code>
  </pre>
  </p>
  <p>
    接下来得计划是先处理服务器端的功能
  </p>
  <p>
    Https的配置,在阿里云上还是比较简单的,就不重复了,自行百度. 顺便给个链接吧<a href="https://yq.aliyun.com/articles/65199">证书如何选择</a>
  </p>
  <p>配置完之后注意Nginx需要的是 先停止然后启动 stop start 不是 reload</p>
  <p>现在我的主页已经能够https访问了,当然没有放弃http,Nginx做一个301跳转既可
    <pre>
    <code>
      server {
          listen 80;
          server_name localhost;
          rewrite ^(.*) https://$host$1 permanent;
      }
      # systemctl stop nginx
      # systemctl start nginx
    </code>
  </pre>
  </p>
</body>

</html>
